version: "3.9"

services:

  compiler:
    profiles:
      - compiler
    build:
      dockerfile: compiler.dockerfile
      context: .
    command: bash /app/src/compiler_entrypoint.sh
    volumes:
      - ./CMakeLists.txt:/app/CMakeLists.txt:ro
      - ./src:/app/src:ro
      - ./builds:/app/builds:rw

  redis:
    profiles:
      - redis
      - generator
      - parser
    image: "redis:alpine"
    command: redis-server /data/redis.conf
    ports:
      - "6379:6379"
    volumes:
      - ./data:/data:rw

  generator:
    profiles:
      - generator
    depends_on:
      - redis
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: "python -u /src/instance_generator_driver.py /data/missing.csv 100 5 3"
    build:
      dockerfile: instance_generator.dockerfile
      context: .
    volumes:
      - ./data:/data:ro
      - ./src:/src:ro
    deploy:
      mode: replicated
      replicas: 7

  parser:
    profiles:
      - parser
    depends_on:
      - redis
    extra_hosts:
      - "host.docker.internal:host-gateway"
    command: "python -u /src/kcmc_instance.py /data/instances.parquet 15 host.docker.internal"
    build:
      dockerfile: notebook.dockerfile
      context: .
    volumes:
      - ./data/instances.parquet:/data/instances.parquet:rw
      - ./src:/src:ro

  notebook:
    profiles:
      - notebook
    build:
      dockerfile: notebook.dockerfile
      context: .
    ports:
      - "8888:8888"
    environment:
      GRB_CLIENT_LOG: 3
      PYTHONPATH: "/home/gurobi/0_analysis/src"
    volumes:
      - ./data/kcmc_gurobi.lic:/opt/gurobi/gurobi.lic:ro
      - ./data:/data:ro
      - ./analysis:/home/gurobi/0_analysis:rw
      - ./src:/home/gurobi/0_analysis/src:ro

  gurobi:
    profiles:
      - gurobi
    image: gurobi/python:9.1.2
    command: python "/home/gurobi/src/gurobi_optimizer.py" -t 300 -p 8 -k 5 -m 3 -i "KCMC;50 125 12;700 100 100;90116672;PS;0 6;0 20;0 23;0 38;0 47;0 54;0 61;0 77;0 87;0 95;0 120;1 3;1 6;1 9;1 11;1 29;1 38;1 48;1 50;1 54;1 76;1 95;1 105;1 112;1 120;2 18;2 19;2 32;2 46;2 52;2 57;2 84;2 93;2 109;3 14;3 43;3 44;3 49;3 69;3 78;3 89;3 107;3 110;4 3;4 6;4 9;4 11;4 25;4 29;4 38;4 48;4 50;4 54;4 76;4 95;4 105;4 112;4 120;5 14;5 43;5 44;5 49;5 69;5 78;5 82;5 89;5 107;6 18;6 19;6 32;6 46;6 52;6 57;6 84;6 93;6 109;7 6;7 23;7 38;7 47;7 54;7 61;7 77;7 87;7 95;7 120;8 6;8 23;8 38;8 54;8 61;8 77;8 87;8 95;8 120;9 2;9 14;9 36;9 43;9 49;9 69;9 104;9 110;10 14;10 43;10 44;10 49;10 69;10 78;10 82;10 89;10 107;11 5;11 18;11 20;11 35;11 47;11 52;11 77;11 88;11 93;11 96;12 25;12 29;12 34;12 37;12 48;12 85;12 101;12 102;12 103;12 105;12 112;12 121;13 34;13 37;13 85;13 101;13 102;13 103;13 121;14 5;14 20;14 35;14 47;14 61;14 77;14 88;14 96;15 2;15 14;15 36;15 43;15 49;15 69;15 104;15 110;16 5;16 18;16 19;16 32;16 51;16 52;16 57;16 84;16 93;16 109;17 14;17 43;17 44;17 49;17 69;17 78;17 89;17 107;17 110;18 3;18 11;18 25;18 29;18 37;18 48;18 50;18 76;18 98;18 105;18 112;19 32;19 44;19 46;19 78;19 82;19 84;19 89;19 107;19 109;20 18;20 19;20 32;20 52;20 57;20 84;20 93;20 109;21 6;21 23;21 38;21 47;21 54;21 61;21 77;21 87;21 95;21 120;22 25;22 29;22 34;22 37;22 48;22 85;22 101;22 102;22 103;22 105;22 112;22 121;23 5;23 20;23 35;23 47;23 52;23 77;23 88;23 93;23 96;24 6;24 20;24 23;24 35;24 38;24 47;24 61;24 77;24 87;24 88;24 95;24 120;25 44;25 46;25 78;25 82;25 89;25 107;26 32;26 44;26 46;26 78;26 82;26 84;26 89;26 107;26 109;27 3;27 6;27 9;27 11;27 23;27 38;27 50;27 54;27 76;27 95;27 120;28 5;28 20;28 35;28 47;28 52;28 77;28 88;28 93;28 96;29 25;29 29;29 34;29 37;29 48;29 76;29 101;29 102;29 103;29 105;29 112;30 5;30 20;30 35;30 47;30 61;30 77;30 88;30 96;31 14;31 43;31 44;31 49;31 69;31 78;31 82;31 89;31 107;32 3;32 9;32 11;32 25;32 29;32 48;32 50;32 76;32 98;32 105;32 112;33 6;33 20;33 23;33 38;33 47;33 54;33 61;33 77;33 87;33 88;33 95;33 120;34 18;34 19;34 32;34 44;34 46;34 57;34 78;34 82;34 84;34 93;34 107;34 109;35 25;35 34;35 37;35 85;35 101;35 102;35 103;35 105;35 121;36 14;36 43;36 49;36 69;36 78;36 89;36 110;37 5;37 18;37 19;37 35;37 52;37 57;37 88;37 93;37 109;38 5;38 18;38 19;38 20;38 35;38 47;38 52;38 88;38 93;38 96;39 25;39 34;39 37;39 48;39 85;39 101;39 102;39 103;39 105;39 121;40 18;40 19;40 32;40 52;40 57;40 84;40 93;40 109;41 2;41 14;41 43;41 49;41 69;41 89;41 104;41 110;42 44;42 46;42 78;42 82;42 89;42 107;43 3;43 6;43 9;43 11;43 25;43 29;43 38;43 48;43 50;43 54;43 76;43 95;43 98;43 105;43 112;43 120;44 2;44 14;44 36;44 43;44 49;44 69;44 104;44 110;45 3;45 6;45 9;45 11;45 25;45 29;45 38;45 48;45 50;45 54;45 76;45 95;45 105;45 112;45 120;46 37;46 85;46 101;46 102;46 103;47 2;47 14;47 43;47 49;47 69;47 89;47 104;47 110;48 14;48 43;48 44;48 49;48 69;48 78;48 89;48 107;48 110;49 6;49 11;49 23;49 38;49 54;49 61;49 77;49 87;49 95;49 120;SS;2 14;2 17;2 36;2 41;2 43;2 49;2 56;2 58;2 59;2 68;2 69;2 97;2 99;2 104;2 110;2 123;3 8;3 9;3 10;3 11;3 23;3 29;3 50;3 53;3 60;3 61;3 64;3 65;3 70;3 75;3 76;3 86;3 87;3 90;3 91;3 95;3 98;3 105;3 112;3 115;3 120;5 12;5 13;5 18;5 19;5 26;5 32;5 35;5 42;5 45;5 47;5 51;5 52;5 66;5 72;5 79;5 88;5 92;5 94;5 100;5 106;5 109;5 113;5 117;6 8;6 9;6 20;6 23;6 33;6 38;6 53;6 54;6 60;6 61;6 70;6 77;6 87;6 90;6 91;6 95;6 96;6 98;6 111;6 119;6 120;9 10;9 11;9 23;9 29;9 50;9 53;9 60;9 61;9 65;9 70;9 76;9 86;9 87;9 90;9 91;9 95;9 98;9 112;9 115;9 120;11 23;11 29;11 50;11 53;11 60;11 61;11 64;11 65;11 70;11 75;11 76;11 86;11 87;11 90;11 91;11 95;11 98;11 112;11 115;11 120;14 17;14 22;14 27;14 41;14 43;14 49;14 56;14 58;14 68;14 69;14 82;14 83;14 97;14 99;14 104;14 110;14 116;14 123;18 19;18 24;18 31;18 32;18 35;18 42;18 45;18 52;18 57;18 66;18 71;18 72;18 74;18 80;18 84;18 92;18 93;18 100;18 106;18 109;18 113;18 117;18 118;19 24;19 31;19 32;19 35;19 42;19 45;19 52;19 66;19 72;19 74;19 80;19 84;19 92;19 93;19 100;19 106;19 109;19 113;19 117;19 118;20 26;20 35;20 42;20 47;20 51;20 52;20 54;20 66;20 72;20 77;20 79;20 88;20 92;20 94;20 96;20 111;20 113;20 117;23 33;23 38;23 54;23 61;23 70;23 77;23 87;23 88;23 90;23 91;23 94;23 95;23 96;23 111;23 119;23 120;25 29;25 48;25 50;25 53;25 55;25 60;25 64;25 65;25 75;25 76;25 81;25 86;25 101;25 103;25 105;25 112;25 114;25 115;25 124;29 48;29 50;29 53;29 55;29 60;29 64;29 65;29 75;29 76;29 81;29 86;29 101;29 103;29 105;29 112;29 115;29 124;32 57;32 62;32 71;32 74;32 80;32 84;32 93;32 100;32 106;32 118;32 122;34 37;34 40;34 48;34 55;34 81;34 85;34 101;34 103;34 114;34 124;35 42;35 45;35 47;35 51;35 52;35 66;35 72;35 77;35 79;35 88;35 92;35 94;35 96;35 109;35 111;35 113;35 117;36 43;36 49;36 56;36 58;36 59;36 97;36 99;36 104;36 110;36 123;37 39;37 40;37 48;37 55;37 63;37 64;37 75;37 81;37 85;37 101;37 102;37 103;37 105;37 114;37 121;37 124;38 53;38 54;38 60;38 61;38 70;38 77;38 87;38 90;38 91;38 95;38 96;38 98;38 111;38 119;38 120;43 49;43 56;43 58;43 68;43 69;43 82;43 83;43 97;43 99;43 104;43 110;43 116;43 123;44 46;44 57;44 62;44 67;44 71;44 73;44 78;44 82;44 83;44 89;44 107;44 108;44 116;44 118;44 122;46 57;46 62;46 71;46 73;46 74;46 78;46 80;46 84;46 89;46 107;46 108;46 118;46 122;47 51;47 52;47 54;47 72;47 77;47 79;47 88;47 92;47 94;47 96;47 111;47 117;47 119;48 50;48 53;48 55;48 60;48 64;48 65;48 75;48 76;48 81;48 86;48 101;48 103;48 105;48 112;48 115;48 124;49 56;49 58;49 67;49 68;49 69;49 82;49 83;49 97;49 99;49 104;49 110;49 116;49 123;50 53;50 60;50 61;50 64;50 65;50 70;50 75;50 76;50 86;50 87;50 90;50 91;50 95;50 98;50 101;50 105;50 112;50 115;50 120;51 100;51 106;52 66;52 72;52 74;52 80;52 84;52 92;52 93;52 100;52 106;52 109;52 113;52 117;52 118;54 61;54 70;54 87;54 90;54 91;54 95;54 98;54 119;54 120;57 66;57 74;57 80;57 84;57 93;57 100;57 106;57 109;57 113;57 118;61 77;61 79;61 88;61 94;61 96;61 111;61 119;69 82;69 83;69 97;69 99;69 104;69 110;69 116;69 123;76 81;76 86;76 95;76 98;76 101;76 103;76 105;76 112;76 115;76 120;77 79;77 88;77 90;77 91;77 92;77 94;77 96;77 111;77 117;77 119;78 82;78 83;78 89;78 107;78 108;78 116;78 118;78 122;82 89;82 107;82 108;82 122;84 89;84 93;84 100;84 106;84 107;84 108;84 118;84 122;85 102;85 114;85 121;85 124;87 88;87 90;87 91;87 94;87 96;87 111;87 119;88 92;88 94;88 96;88 109;88 111;88 113;88 117;89 107;89 108;89 116;89 122;93 100;93 106;93 109;93 113;93 117;93 118;95 96;95 98;95 111;95 119;95 120;96 111;96 117;98 105;98 112;98 115;101 103;101 114;101 124;102 103;102 114;102 121;102 124;103 105;103 114;103 121;103 124;104 110;104 123;105 112;105 115;105 124;107 108;107 116;107 118;107 122;109 118;110 116;110 123;112 115;112 124;121 124;SK;3 1;3 2;3 3;3 4;3 6;3 7;3 8;3 10;5 5;6 2;6 11;9 2;9 3;9 4;9 8;9 10;11 1;11 2;11 3;11 4;11 6;11 7;11 8;11 10;20 5;20 11;23 11;25 1;25 2;25 3;25 4;25 6;25 7;25 8;25 10;29 1;29 2;29 3;29 4;29 6;29 7;29 8;29 10;34 0;35 5;35 11;37 0;37 1;37 7;37 9;38 2;38 11;47 5;47 11;48 1;48 2;48 3;48 4;48 6;48 7;48 8;48 10;50 1;50 2;50 3;50 4;50 6;50 7;50 8;50 10;52 5;61 11;76 1;76 2;76 3;76 4;76 6;76 7;76 8;76 10;77 5;77 11;85 0;85 9;87 11;88 5;88 11;95 2;95 11;96 5;98 1;98 2;98 3;98 4;98 6;98 7;98 8;98 10;101 0;101 9;102 0;102 9;103 0;103 9;105 1;105 2;105 3;105 4;105 6;105 7;105 8;105 10;112 1;112 2;112 3;112 4;112 6;112 7;112 8;112 10;120 2;120 11;121 0;END"
    environment:
      GRB_CLIENT_LOG: 3
      PYTHONPATH: "/home/gurobi/src"
    volumes:
      - ./data/kcmc_gurobi.lic:/opt/gurobi/gurobi.lic:ro
      - ./data:/data:ro
      - ./src:/home/gurobi/src:ro
      - ./analysis/results:/home/gurobi/results:rw
